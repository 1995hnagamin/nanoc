***************
*** 7,15 ****
      identifier :stale
  
      def run
-       require 'set'
- 
-       item_rep_paths = Set.new(@site.items.collect { |i| i.reps }.flatten.collect { |r| r.raw_path })
  
        self.output_filenames.each do |f|
          next if self.pruner.filename_excluded?(f)
--- 7,13 ----
      identifier :stale
  
      def run
+       item_rep_paths = self.item_rep_paths
  
        self.output_filenames.each do |f|
          next if self.pruner.filename_excluded?(f)
***************
*** 21,31 ****
        end
      end
  
-     protected
  
      def pruner
-       exclude_config = @site.config.fetch(:prune, {}).fetch(:exclude, [])
-       @pruner ||= Nanoc::Extra::Pruner.new(@site, :exclude => exclude_config)
      end
  
    end
--- 19,38 ----
        end
      end
  
+   protected
+ 
+     def item_rep_paths
+       reps = @site.items.flat_map { |i| i.reps }
+       reps.flat_map { |r| r.paths_without_snapshot }.map { |r| File.join(@site.config[:output_dir], r) }
+     end
  
      def pruner
+       @pruner ||= begin
+         exclude_config = @site.config.fetch(:prune, {}).fetch(:exclude, [])
+         identifier = self.site.compiler.item_rep_writer.class.identifier
+         pruner_class = Nanoc::Extra::Pruner.named(identifier)
+         pruner_class.new(@site, :exclude => exclude_config)
+       end
      end
  
    end
